# Работа с заявками клиентов

## Договоры на абонентское обслуживание

Необходимо добавить новый вид договоров – абоненское обслуживание. В договорах такого вида пользователь должен иметь возможность внести дату начала действия договора, дату окончания действия договора, сумму ежемесячной абоненсткой платы и стоимость часа работы специалиста.

**Алгоритм решения задачи:**
1. Добавить новый элемент перечисления ВидыДоговоровКонтрагентов.
2. Добавить в справочник ДоговорыКонтрагентов реквизиты для хранения периода действия договора, суммы абонентской платы и стоимость часа работы.
3. Вывести на форму новые реквизиты договора, если выбран соответствующий вид договора.

*Примечание: не забудьте, что изменения формы реализуются программно, новые объекты и методы добавляются с префиксом.*

## Обслуживание клиентов

Необходимо планировать обслуживание сотрудниками оборудования и программ клиентов. 

Процесс работы с заявками построен следующим образом:
1. Клиент звонит менеджеру и оставляет заявку на работу специалиста с указанием проблемы, для решения которой нужен специалист.
2. Менеджер ищет свободное время и планирует заявку на это время.
3. При планировании телеграм-бот оповещает специалистов о появлении новой заявки.
4. Специалист в назначенное время в офисе клиента или удалённо проводит необходимые работы.
5. Специалист получает подписанный лист учёта рабочего времени или скан/фото листа учёта от клиента. В листе учёта перечисляются виды работ, выполненные специалистом, и фиксируется количество часов к оплате. В дальнейшем документ будет являться подтверждением проведения работ.
6. Специалист вносит в информационную систему информацию о выполненных работах, количество фактически потраченных часов на каждый вид работы, количество часов к оплате клиенту за каждый вид работы и прикрепляет к документу скан/фото листа учёта рабочего времени.

Все объекты, связанные с обслуживанием клиентов, должны располагаться в новой подсистеме Обслуживание клиентов.

**Алгоритм решения задачи:**
1. Добавьте документ ОбслуживаниеКлиента
2. В документ добавьте реквизиты:
    - Клиент
    - Договор
    - Специалист
    - Дата проведения работ
    - Время начала работ (план)
    - Время окончания работ (план)
    - Описание проблемы
    - Комментарий
3. В документ добавьте табличную часть ВыполненныеРаботы с колонками:
    - Описание работ
    - Фактически потрачено часов
    - Часы к оплате клиенту
4. Реализуйте форму документа и форму списка с разумным размещением полей, подключите к формам подсистему Подключаемые команды
5. Добавьте возможность хранить присоединенные к документу файлы
6. Создайте роль для работы с документом
7. Добавьте регистр накопления для хранения информации о суммах задолженности клиента ВыполненныеКлиентуРаботы
    - Измерения - Клиент, Договор
    - Ресурсы - Количество часов, Сумма к оплате
8. Реализуйте проверку при проведении документа, что выбран договор с типом абонентская плата и что дата документа лежит между датой начала и датой окончания действия договора
9. Реализуйте обработку проведения по регистру накопления. Сумма к оплате должна рассчитываться исходя из ставки часа, указанной в договоре
10. Добавьте документ в подсистему Обслуживание клиентов
11. Для оповещения через Телеграм создайте константы:
    - токен управления телеграм-ботом
    - идентификатор группы для оповещения
12. Реализуйте отдельный общий модуль для интеграции с телеграм-ботом в соответствии с [описанием реализации](telegram.md)
13. Создайте справочник Уведомления телеграм-боту для отправки с нулевой длиной кода и наименования и реквизитом Текст сообщения (строка бесконечной длины)
14. При записи документа Обслуживание клиента, если документ записывается первый раз или если дата, время или специалист изменились, добавьте в справочник сообщение с текстом, описывающим изменения.
15. Добавьте регламентное задание, которое будет обходить элементы справочника Уведомления, отправлять и после успешной отправки удалять элементы справочника.

### Дополнительное задание для Обслуживания клиентов*
*Это задание не является обязательным требованием, однако вы можете изучить дополнительный материал, реализовать механизм и получить комментарий по реализованному механизму от дипломного руководителя.*

Для удобного планирования времени специалистов необходимо реализовать календарь загрузки на базе Планировщика.

**Алгоритм решения задачи:**
1. Изучите информацию о планировщике в справке о платформе 1С:Предприятие и материалам в открытом доступе
2. Добавьте обработку Календарь специалистов, которая будет отображать документы Обслуживание клиентов в календаре в разрезе специалистов
3. Реализуйте возможность создания обслуживания из календаря с автоматическим заполнением специалиста, времени начала и времени окончания
4. Реализуйте автоматическое обновление данных планировщика при изменении документов Обслуживание клиентов с помощью метода Оповестить
5. Добавьте календарь на начальную страницу
[Пример использования планировщика на канале сообщества 1С-Разработчиков Фирмы 1С](https://youtu.be/oHkJO9h7m9A?t=2893)

## Заполнение Реализации товаров и услуг

Если в документе Реализации товаров и услуг выбран договор с видом абонентская плата, то необходимо реализовать возможность автозаполнения такого документа суммой ежемесячной абонентской платы и суммой за выполненные в течения месяца работы по данным документов Обслуживание клиентов.
Из документа должен печататься акт об оказанных услугах.

**Алгоритм решения задачи:**
1. Добавьте константы НоменклатураАбонентскаяПлата и НоменклатураРаботыСпециалиста с типом ссылка на справочник Номенклатура
2. Добавьте на форму Реализации товаров и услуг команду Заполнить
3. Команда Заполнить должна проверять вид договора. Если это договор абонентского обслуживания, то вызывать процедуру ВыполнитьАвтозаполнение из модуля объекта документа
4. В модуле объекта реализуйте процедуру ВыполнитьАвтозаполнение, которая:
    - получит номенклатуру из констант НоменклатураАбонентскаяПлата и НоменклатураРаботыСпециалиста, если хотя бы одна не заполнена, необходимо выдать ошибку и прекратить выполнение процедуры,
    - очистит табличную часть.

      Если в договоре ненулевая сумма абонентской платы, добавьте в табличную часть строку с номенклатурой из константы НоменклатураАбонентскаяПлата и суммой абонентской платы из договора.

      Если в месяц даты документа в регистре ВыполненныеКлиентуРаботы есть информация о выполненных работах по этому договору, добавьте в табличную часть строку с номенклатурой из константы НоменклатураРаботыСпециалиста и общим количеством и суммой из регистра ВыполненныеКлиентуРаботы за месяц документа.

5. Реализуйте для документа печатную форму акта об оказанных услугах. Акт может быть произвольной формы, но должен содержать следующие данные:
    - номер и дату документа,
    - информацию о Контрагенте, Организации и договоре,
    - детализацию из табличной части документа (номенклатуру, количество, цену, сумму),
    - итоговую сумму цифрами и прописью,
    - поля для подписей ответственных лиц и печати.

      Акт может быть реализован в виде mxl или docx. У пользователя должна быть возможность редактирования макета акта.

## Массовое создание документов Реализация товаров и услуг

В начале месяца бухгалтер фирмы формирует акты по всем абонентским договорам. Необходимо автоматизировать эту процедуру.

**Алгоритм решения задачи:**
1. Создайте обработку МассовоеСозданиеАктов
2. Добавьте реквизит обработки Период для указания месяца
3. Добавьте табличную часть для хранения списка договоров и ссылок на созданные Реализации по этим договорам за период
4. Реализуйте интерфейс для работы с обработкой
5. Реализуйте алгоритм заполнения табличной части и создания реализаций со следующими особенностями:
    - алгоритм должен выполняться с использованием механизма длительных операций БСП,
    - если Реализация за выбранный месяц уже создана, то обработка не должна создавать вторую,
    - при создании Реализации необходимо вызывать стандартный алгоритм заполнения,
    - для заполнения Реализации необходимо использовать метод модуля объекта Реализации ВыполнитьАвтозаполнение,
    - перед проведением Реализации необходимо вызывать стандартный алгоритм проверки заполнения.
6. Добавьте обработку в подсистему Обслуживание клиентов
    
## Права доступа

Документы Обслуживание клиентов вводят специалисты и менджеры. Массовое создание документов Реализации использует бухгалтер.

**Алгоритм решения задачи:**
1. Создайте необходимые роли для работы с объектами
2. Добавьте поставляемые профили групп доступа Специалист, Менеджер, БухгалтерИТФирмы
3. Добавьте в профили роли
